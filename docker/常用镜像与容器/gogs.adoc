= 在Docker中搭建gogs
:scripts: cjk
:toc:
:toc-title: 目录
:toclevels: 4

== 单机

```sh
# Create local directory for volume.
mkdir -p /var/gogs

# Use `docker run` for the first time.
docker run --name=gogs -dp 10022:22 -p 10080:3000 -v /var/gogs:/data --restart always gogs/gogs
```

* 如果指定使用同为docker容器内的mysql数据库，请用link参数

```sh
docker run --name=gogs -dp 10022:22 -p 10080:3000 -v /var/gogs:/data --restart always --link mysql:mysql  gogs/gogs
```

* 打开防火墙端口

```sh
firewall-cmd --zone=dmz --permanent --add-port=10022/tcp
firewall-cmd --zone=dmz --permanent --add-port=10080/tcp
firewall-cmd --reload
```

== swarm
[,shell]
----
mkdir -p /usr/local/gogs/conf
----

./usr/local/gogs/conf/app.ini
[source,ini,linenums]
----
[database]
TYPE     = sqlite3
HOST     = 127.0.0.1:5432
NAME     = gogs
SCHEMA   = public
USER     = gogs
PASSWORD =
SSL_MODE = disable
PATH     = data/gogs.db

[server]
DOMAIN           = localhost
HTTP_PORT        = 3000
EXTERNAL_URL     = https://xxx.xxx.xxx.xxx:xxxxx/gogs/
DISABLE_SSH      = false
SSH_PORT         = 22
START_SSH_SERVER = false
OFFLINE_MODE     = false
----

[NOTE]
====
注意修改 *EXTERNAL_URL* 的值为外部访问的地址
====

./usr/local/gogs/stack.yml
[source,yaml,linenums]
----
version: "3.9"

services:
  svr:
    image: gogs/gogs
    volumes:
      - gogsdata:/data
      - /usr/local/gogs/conf/app.ini:/data/gogs/conf/app.ini:z
    environment:
      # 最好使用此设定时区，其它镜像也可以使用
      - TZ=CST-8
    logging:
      options:
        max-size: 8m
    deploy:
      endpoint_mode: dnsrr
      placement:
        constraints:
          - node.hostname==xxx

volumes:
  gogsdata:

networks:
  default:
    external: true
    name: rebue
----

[NOTE]
====
注意修改 *node.hostname* 的值为实际部署的服务器的主机名
====

- 部署

[,shell]
----

----


== 初始化

. 访问 <http://ip:3000>
. 数据库类型改为 `SQLite3`
. 应用URL设置为 https://xxx:8000/gogs/
  * `xxx` 为域名
  * `/gogs/` 为子路径
. 注册新用户
  第一次注册的用户即为管理员
