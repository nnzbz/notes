= 制作RabbitMQ的Docker容器
:scripts: cjk
:toc: left
:toclevels: 3
:toc-title: 目录
:numbered:
:sectnums:
:sectnum-depth: 3
:source-highlighter: coderay

[TOC]

== 参考

<https://hub.docker.com/_/rabbitmq>
<https://www.rabbitmq.com/clustering.html>
<https://medium.com/hepsiburadatech/implementing-highly-available-rabbitmq-cluster-on-docker-swarm-using-consul-based-discovery-45c4e7919634>

== 单机

[source,shell]
----
mkdir ~/opt/rabbitmq
----

.~/opt/rabbitmq/stack.yml
[source,yaml,%linenums]
----
services:
  rabbitmq:
    image: rabbitmq:management-alpine
    hostname: rabbitmq
    container_name: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=user
      - RABBITMQ_DEFAULT_PASS=password
      - TZ=CST-8
    logging:
      options:
        max-size: 8m
    restart: unless-stopped
----

- 部署

[,shell]
----
docker compose -f ~/opt/rabbitmq/stack.yml up -d
----

== Swarm

=== 部署文件

[source,shell]
----
mkdir -p ~/opt/rabbitmq
vi ~/opt/rabbitmq/stack.yml
----

.~/opt/rabbitmq/stack.yml
[source,yaml,%linenums]
----
services:
  svr:
    image: rabbitmq:management-alpine
    hostname: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      # 最好使用此设定时区，其它镜像也可以使用
      - TZ=CST-8
    deploy:
      placement:
        constraints:
          - node.hostname==rabbitmq00
    logging:
      options:
        max-size: 8m
networks:
  default:
    external: true
    name: rebue
----

=== 部署

[source,shell]
----
docker stack deploy -c ~/opt/rabbitmq/stack.yml rabbitmq
----

== 访问

容器启动之后就可以访问web 管理端了 <http://127.0.0.1:15672> ，默认创建了一个 guest 用户，密码也是 guest。

- 修改密码
  登录后，点击右上角 `guest`，页面下方找到 `Update this user`，填写 `Password` 并 `confirm`，然后 `Update user`

**注意:** 新版本的guest只允许在localhost本地访问，须注册一个新的账户，这里示例添加 `admin` 账户

[source,shell]
----
# 进入容器
docker exec -it '容器ID' /bin/sh
# 添加admin账户并授权
rabbitmqctl add_user admin '密码'
rabbitmqctl set_user_tags admin administrator
rabbitmqctl set_permissions -p / admin ".*" ".*" ".*"
----
